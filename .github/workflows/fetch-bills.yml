name: Fetch WA Legislature Bills

on:
  schedule:
    # Run daily at 6 AM Pacific Time (2 PM UTC)
    - cron: '0 14 * * *'
  workflow_dispatch:  # Allow manual trigger
  push:
    paths:
      - 'fetch_all_bills.py'
      - '.github/workflows/fetch-bills.yml'

jobs:
  fetch-bills:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Test API connectivity
      run: |
        echo "Testing WA Legislature API connectivity..."
        python -c "
import requests
import sys

try:
    response = requests.get('https://wslwebservices.leg.wa.gov/LegislationService.asmx', timeout=10)
    if response.status_code == 200:
        print('SUCCESS: API is reachable')
    else:
        print('WARNING: API returned status', response.status_code)
        sys.exit(1)
except Exception as e:
    print('ERROR: Cannot reach API -', e)
    sys.exit(1)
        "
    
    - name: Run bill fetcher with validation
      id: fetch
      run: |
        echo "Starting bill fetch process..."
        python fetch_all_bills.py
        
        # Check if bills.json was created
        if [ ! -f "data/bills.json" ]; then
          echo "ERROR: bills.json was not created"
          exit 1
        fi
        
        # Validate JSON structure
        python -c "
import json
import sys

try:
    with open('data/bills.json', 'r') as f:
        data = json.load(f)
    
    # Check required fields
    required = ['bills', 'totalBills', 'lastSync', 'metadata']
    missing = [field for field in required if field not in data]
    
    if missing:
        print('ERROR: Missing required fields:', missing)
        sys.exit(1)
    
    # Check bill count
    bill_count = len(data.get('bills', []))
    print('SUCCESS: Loaded', bill_count, 'bills')
    
    if bill_count == 0:
        print('ERROR: No bills found in data')
        sys.exit(1)
    
    # Validate bill structure
    if bill_count > 0:
        sample_bill = data['bills'][0]
        bill_fields = ['id', 'number', 'title', 'status']
        missing_fields = [f for f in bill_fields if f not in sample_bill]
        
        if missing_fields:
            print('WARNING: Sample bill missing fields:', missing_fields)
        
        # Check for valid titles
        valid_titles = [b for b in data['bills'] if b.get('title') and b['title'] != 'No title available']
        print('Bills with valid titles:', len(valid_titles), '/', bill_count)
        
        if len(valid_titles) == 0:
            print('ERROR: No bills have valid titles')
            sys.exit(1)
    
    # Set output for next steps (GitHub Actions format)
    import os
    if 'GITHUB_OUTPUT' in os.environ:
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write('bill_count=' + str(bill_count) + '\\n')
    
except Exception as e:
    print('ERROR: Failed to validate bills.json -', e)
    sys.exit(1)
        "
    
    - name: Create statistics report
      run: |
        python -c "
import json
from datetime import datetime

with open('data/bills.json', 'r') as f:
    data = json.load(f)

bills = data.get('bills', [])

# Calculate statistics
stats = {
    'generated': datetime.now().isoformat(),
    'totalBills': len(bills),
    'byStatus': {},
    'byCommittee': {},
    'byTopic': {},
    'byType': {}
}

for bill in bills:
    # By status
    status = bill.get('status', 'unknown')
    stats['byStatus'][status] = stats['byStatus'].get(status, 0) + 1
    
    # By committee
    committee = bill.get('committee', 'unknown')
    stats['byCommittee'][committee] = stats['byCommittee'].get(committee, 0) + 1
    
    # By topic
    topic = bill.get('topic', 'unknown')
    stats['byTopic'][topic] = stats['byTopic'].get(topic, 0) + 1
    
    # By type
    bill_type = bill.get('number', '').split()[0] if ' ' in bill.get('number', '') else 'unknown'
    stats['byType'][bill_type] = stats['byType'].get(bill_type, 0) + 1

# Save stats
with open('data/stats.json', 'w') as f:
    json.dump(stats, f, indent=2)

print('Statistics generated:', len(bills), 'total bills')
print('By Status:', stats['byStatus'])
print('By Type:', stats['byType'])
        "
    
    - name: Archive sync folder
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: sync-data-${{ github.run_number }}
        path: data/sync/
        retention-days: 7
    
    - name: Commit and push changes
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        
        # Add data files
        git add data/bills.json data/stats.json data/sync-log.json || true
        
        # Check if there are changes
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          # Get bill count for commit message
          BILL_COUNT=$(python -c "import json; d=json.load(open('data/bills.json')); print(len(d.get('bills', [])))")
          
          git commit -m "Update: Fetched $BILL_COUNT bills from WA Legislature [skip ci]"
          git push
        fi
    
    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Bill Fetch Failed - ${new Date().toISOString().split('T')[0]}`,
            body: `The automated bill fetch process failed.\n\nWorkflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\nPlease check the sync folder artifacts for debugging information.`,
            labels: ['bug', 'automated']
          });
